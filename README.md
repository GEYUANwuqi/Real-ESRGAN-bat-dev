# 文件说明
- `example`文件夹：用于超分测试的图片和视频
- `putout`文件夹：输出文件的文件夹，全部输出的最终图片和视频都会存在这里
- `video_frame`文件夹：暂时存放原始视频帧的文件夹
- `out_video_frame`文件夹：暂时存放超分过的视频帧的文件夹
- `ffmpeg`文件夹：用于存放ffmpeg的文件夹（删除则无法使用视频超分功能）
- `models`文件夹：用于存放超分模型的文件夹
- `workenv`文件夹：用于存放Python (3.12.3_Windows)的文件夹（删除则程序崩溃）

- `realesrgan-ncnn-vulkan.exe`：Windows超分程序的本体
- `realesrgan-ncnn-vulkan-linux`：Linux超分程序的本体
- `real_go.py`：调用超分程序的脚本
- `config.json`：超分程序部分参数配置文件
- `open_real_linux.sh`：Linux中启动超分程序的脚本
- `open_real_Windows.bat`：调用指定版本Python 3.12.3, 启动超分程序脚本
- `open_real_Windows_debug.bat`：调用指定版本Python 3.12.3的idle模式, 启动超分程序脚本, 如果有错误信息将会输出

这里的前四个文件夹可以删除以及剪切到其他地方, 不影响使用, 脚本运行时会自动创建所需的文件夹。除了这四个文件夹, 其他的文件均不能删除。

# 模型介绍
- `animex4`："realesrgan-x4plus-anime"（目前次好的模型, 需要最大的显存和时间, 和hq版的比起来多了一些抗锯齿, 但是会丢失部分细节）（用于二次元图超分）
- `ganx4`："realesrgan-x4plus"（三次元域最好的模型, 需要最大的显存和时间）（用于三次元图超分）
- `videox4`："realesr-animevideov3-x4"（用于视频超分）（用于二次元视频超分）
- `videox2`："realesr-animevideov3-x2"（用于视频超分）（用于二次元视频超分）
- `animehqx4`："Anime-HQ-W4xEX"（目前最好的模型, 需要最大的显存和时间, 但是有最好的效果）（用于二次元图超分）
- `generalx4`："realesr-general-wdn-x4v3"（较为全能的模型, 有较快的速度和不输其他模型的效果）（用于通用超分）

# 使用办法
## 常规用法
1. 运行`open_real_Windows.bat`或`open_real_linux.sh`（.sh文件需要在终端中以`./`的方式运行）
2. 根据要超分内容选择模型
3. 选择要超分的文件
4. 填写相应的参数（图片需要输入要超分到的分辨率, 默认长宽x4, 也就是分辨率x16；视频需要输入源视频帧率）
5. 确认文件并等待程序超分完毕
6. 程序会默认将超分后的文件输出到`putout`文件夹中

## 已有视频帧的用法（特用于mmd制作等有渲染帧场景）
1. 前两步和常规用法一样
2. 在输入超分文件的名称时输入`no`
3. 将已有的视频帧以`0001.png`的方式放在`video_frame`文件夹中（注意一定要是`.png`格式）
4. 将音频放在源码目录下（最好音频和视频轨道长度是对齐的, 也可以选择不添加音频, 在下一步输入音频名时输入`no`即可）
5. 输入输出视频的文件名和帧率, 以及放在源码目录下的音频名
6. 确认文件并等待程序超分完毕
7. 程序会默认将超分后的文件输出到`putout`文件夹中

# 配置文件说明
1. `config.json` 是超分程序部分参数配置文件
2. `video` 及 `no_video` 下的 `ca` 是音频编码, `cv` 是视频编码, `bv` 是码率
3. `video` 下参数的修改可以搜索ffmpeg的参数说明, 以找到对应的参数进行修改
4. `image` 下的 `maxpix` 是修改超分图片最大像素, 默认为6400万（8000x8000）, 如果在对超分图片进行二次裁剪时报错, 可以增加这个值, 但不建议调太大
5. `f_format` 下的 `format` 是帧输出格式, 也就是ffmpeg分割视频以及和脚本超分出视频帧的图片的格式（修改此值对照片超分没有影响, png的效果是最好的, 但文件大小略大 `/no` 下的 `format` 是在对已有视频帧超分时, 已有视频帧所用的格式）
6. `gpu` 下的 `id` 参数就是显卡的id, 该id可以通过任务管理器查看, 对于既有核显也有独显的机器, GPU 0有可能为Intel显卡, 请根据情况更换id

# 注意事项
1. 模型的x2和x4等均是对长和宽进行乘法, 即500x500的图片使用x4模型后将会超分至2000x2000, 以及1920x1080的视频使用x2模型后将会超分至3840x2160
2. 图片输出默认为`.png`无损压缩, 视频输出默认为`.mkv`（h265_hevc）, 50MB的码率, 正常超分视频的音频编码为copy原视频的, 已有视频帧的视频格式为`.mkv`, 音频编码为pcm（浮点32位, 采样率同原音频）
3. 对已有视频帧超分后, 会调用ffmpeg合成, 合成完毕后视频帧（源帧和超分的帧）会全部删除, 如果要保留视频帧, 请在合成时对视频帧进行转移
4. 程序运行环境为一台搭载有显卡（Intel/NVIDIA/AMD）的电脑, cpu及Macos超分请自行测试或使用其他项目
5. 因为对超分文件进行检索时是匹配的文件名, 所以如果有与超分文件名相同的其他后缀文件, 可能会导致报错
6. 进行视频超分时会生成大量的`.png`文件, 一帧一个文件大概有6MB/f左右（4k图片）, 一定要注意硬盘的空间
7. 虽然确实可以用x4模型把540p的视频超成4k, 但是限于视频本身, 不建议这么干
8. 对于Linux的使用, 因为ffmpeg和Python存在版本问题, json里一些参数可能并不兼容, 脚本里一些用法也不一定支持, 解决办法是更新Python和ffmpeg或者调整json中不支持的参数
9. 用普通播放器播放`.mkv`格式的视频可能会出现问题, 例如音频丢失, 这里换成potplayer播放可以解决问题

# 备注
脚本是缝缝补补的, 有很多屎山代码, 作者懒得优化所以可能存在一些bug, 如果发现bug请反馈
有其他问题可以通过B站联系我（https://space.bilibili.com/621240130）, 或者邮箱也是可以的（627350525@qq.com, QQ同号）
以及如果有想自己解决的话, 就打开`open_real_Windows_debug.bat`以idle的方式运行（Linux在终端中运行本身也会输出错误信息）, 这样运行可以看到详细的错误信息, 然后就自己百度/Google吧
脚本开发 by 伍昱yu物起（bili_uid:621240130）
超分程序 Real_ESRGAN: https://github.com/xinntao/Real-ESRGAN

# 待办列表
- [ ] 批量超分的支持
- [ ] 优化代码逻辑以及函数命名
- [ ] 对macOS的支持（长期研究）
- [x] 支持更新ncnn模型(几乎能找到的可以用的模型在上面已经列出来了)